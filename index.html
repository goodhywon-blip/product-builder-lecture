<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="google-adsense-account" content="ca-pub-7713287823701747">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hangul Name Studio</title>
  <meta name="description" content="Write your English name in Hangul. Dictionary-first accuracy + smart fallback. Browser-only."/>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;600;700&display=swap" rel="stylesheet">
  <script>
    tailwind = {
      corePlugins: { preflight: false }
    };
  </script>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-Y3970CRW71"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-Y3970CRW71');
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7713287823701747" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="style.css" />
  <script type="text/javascript">
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "vp05ecic8s");
  </script>
</head>

<body>
  <div class="wrap">
    <header class="reveal">
      <div class="brand">
        <div class="mark" aria-hidden="true"><img src="assets/taegeuk.png" alt="" /></div>
        <div>
          <h1>Hangul Name Studio</h1>
          <p>English name ‚Üí natural Hangul spelling</p>
        </div>
      </div>
      <div class="top-actions"></div>
    </header>

    <nav class="nav reveal delay-1" aria-label="Page">
      <a href="#tool">Convert</a>
      <a href="#community" id="communityNav">Community</a>
      <a href="#about">About</a>
    </nav>

    <section class="hero reveal delay-2">
      <h2 class="headline">Write your name in Hangul</h2>
      <p class="subhead">Clean conversion. Community-checked.</p>
    </section>

    <section id="tool" class="grid">
      <section class="card reveal delay-3">
        <div class="inner">
          <div class="row">
            <div class="field" role="group" aria-label="Name input">
              <div class="icon" aria-hidden="true">Aa</div>
              <input id="nameInput" placeholder="e.g., Jacob / Jason / Michael" autocomplete="off" />
            </div>
            <button class="btn primary" id="convertBtn">Convert</button>
          </div>

          <div class="results" id="results">
            <div id="resultBox" class="mt-4">
              <div class="result-layout">
                <div class="result-segment">
                  <div class="hangul-banner" aria-label="Hangul display">
                    <div id="hangulDisplay" class="hangul-large">‚Äî</div>
                  </div>
                  <div class="practice-cta">
                    <button id="practiceToggle" class="btn ghost" type="button" aria-expanded="false" aria-controls="practicePanel">
                      üñä Practice writing
                    </button>
                  </div>
                  <div id="practicePanel" class="practice-panel" hidden>
                    <div class="practice-block">
                      <div class="practice-title">Syllable breakdown</div>
                      <div id="syllableList" class="syllable-list"></div>
                    </div>
                    <div class="practice-block">
                      <div class="practice-title">How to write</div>
                      <div id="jamoGuideList" class="jamo-guide"></div>
                    </div>
                    <div class="practice-actions">
                      <button id="printPracticeBtn" class="btn" type="button">üñ® Print practice sheet</button>
                    </div>
                  </div>
                </div>
                <div class="result-segment">
                  <div
                    id="idCard"
                    class="relative mx-auto w-full max-w-[640px] aspect-[85.6/54] rounded-2xl overflow-hidden shadow-lg border border-black/10 font-['Noto_Serif_KR']"
                  >
                    <img
                      src="assets/honorary_id_bg.png"
                      alt="Honorary ID background"
                      class="absolute inset-0 w-full h-full object-cover"
                    />
                    <div class="absolute inset-0 bg-black/5"></div>

                    <div class="relative h-full p-5 sm:p-6 text-[#3b2f20]">
                      <div class="absolute left-[8%] bottom-[18%] right-[8%] text-[#3b2f20]">
                        <div id="hangulName" class="text-2xl sm:text-3xl font-bold mt-1">‚Äî</div>
                        <div id="englishName" class="text-xs sm:text-sm tracking-wide opacity-80">English Name</div>
                      </div>
                    </div>
                  </div>

                  <div class="mt-3 flex flex-wrap gap-2 items-center">
                    <button id="saveIdBtn" class="px-4 py-2 rounded-lg bg-emerald-700 text-white text-sm hover:bg-emerald-800">
                      Save ID Card
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </section>

    <section id="community" class="section reveal delay-2">
      <div class="section-head">
        <h3>Community</h3>
        <span>Reviewed</span>
      </div>
      <p class="text">Suggestions open in a light modal to keep the page clean.</p>
      <div class="row" style="margin-top:10px;">
        <button class="btn ghost" id="communityOpenBtn">Open community</button>
      </div>
    </section>

    <section id="about" class="section reveal delay-3">
      <div class="section-head">
        <h3>About</h3>
        <span>Minimal by design</span>
      </div>
      <p class="text">
        Dictionary-first spelling, refined by the community. See details on the About and Privacy pages.
      </p>
      <div class="row" style="margin-top:10px;">
        <a class="btn ghost" href="about.html">About</a>
        <a class="btn ghost" href="privacy.html">Privacy</a>
        <a class="btn ghost" href="terms.html">Terms</a>
        <a class="btn ghost" href="contact.html">Contact</a>
      </div>
    </section>

    <footer class="reveal delay-5">
      ¬© <span id="year"></span> Hangul Name Studio ¬∑
      <a href="privacy.html">Privacy</a> ¬∑ <a href="terms.html">Terms</a> ¬∑ <a href="contact.html">Contact</a>
    </footer>
  </div>

  <div class="toast" id="toast">Copied!</div>
  <div class="modal" id="communityModal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal-card">
      <div class="modal-head">
        <h3 class="modal-title">Community suggestions</h3>
        <button class="modal-close" id="communityCloseBtn" type="button">Close</button>
      </div>
      <div class="modal-body">
        <div class="row" style="margin-top:10px;">
          <div class="field" style="flex:1 1 240px">
            <div class="icon" aria-hidden="true">EN</div>
            <input id="suggestKey" placeholder="Name key" autocomplete="off" />
          </div>
          <div class="field" style="flex:1 1 240px">
            <div class="icon" aria-hidden="true">Í∞Ä</div>
            <input id="suggestHangul" placeholder="Suggested Hangul" autocomplete="off" />
          </div>
        </div>
        <div class="row" style="margin-top:10px;">
          <button class="btn" id="submitSuggestionBtn">Submit suggestion</button>
        </div>
        <div class="community-list" id="communityList"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" crossorigin="anonymous"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp,
      collection, query, where, orderBy, limit, getDocs, runTransaction, enableIndexedDbPersistence
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

    // ------------------------------
    // Firebase config (replace with your project values)
    // ------------------------------
    const firebaseConfig = {
      apiKey: "AIzaSyBU-bWMdsusXQ3Uc_vxOvRlpp2FsNrtszc",
      authDomain: "productbuilder-week1-fccc8.firebaseapp.com",
      projectId: "productbuilder-week1-fccc8",
      storageBucket: "productbuilder-week1-fccc8.firebasestorage.app",
      messagingSenderId: "652260101175",
      appId: "1:652260101175:web:d905f7b2ff34e0a96043b2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    enableIndexedDbPersistence(db).catch(() => {});

    // ------------------------------
    // Storage keys
    // ------------------------------

    // ------------------------------
    // Built-in dictionary (seed)
    // ------------------------------
    const BUILTIN_DICT = new Map([
      ["alex", ["ÏïåÎ†âÏä§"]],
      ["alexa", ["ÏïåÎ†âÏÇ¨"]],
      ["alexander", ["ÏïåÎ†âÏÇ∞Îçî","ÏïåÎ†âÏÇ∞ÎçîÎ•¥"]],
      ["alexis", ["ÏïåÎ†âÏãúÏä§"]],
      ["alice", ["Ïï®Î¶¨Ïä§"]],
      ["allen", ["Ïï®Îü∞"]],
      ["alan", ["Ïï®Îü∞"]],
      ["andrew", ["Ïï§ÎìúÎ£®"]],
      ["anna", ["ÏïàÎÇò"]],
      ["annie", ["Ïï†Îãà"]],
      ["anthony", ["Ïï§ÏÑúÎãà"]],
      ["arthur", ["ÏïÑÏÑú"]],
      ["ava", ["ÏóêÏù¥Î∞î"]],
      ["bella", ["Î≤®Îùº"]],
      ["ben", ["Î≤§"]],
      ["benjamin", ["Î≤§ÏûêÎØº"]],
      ["brian", ["Î∏åÎùºÏù¥Ïñ∏"]],
      ["bryan", ["Î∏åÎùºÏù¥Ïñ∏"]],
      ["carl", ["Ïπº"]],
      ["carol", ["Ï∫êÎü¥"]],
      ["charles", ["Ï∞∞Ïä§"]],
      ["charlie", ["Ï∞∞Î¶¨"]],
      ["chris", ["ÌÅ¨Î¶¨Ïä§"]],
      ["christian", ["ÌÅ¨Î¶¨Ïä§Ï≤ú"]],
      ["christina", ["ÌÅ¨Î¶¨Ïä§Ìã∞ÎÇò"]],
      ["christine", ["ÌÅ¨Î¶¨Ïä§Ìã¥"]],
      ["christopher", ["ÌÅ¨Î¶¨Ïä§ÌÜ†Ìçº"]],
      ["daniel", ["Îã§ÎãàÏóò"]],
      ["danielle", ["Îã§ÎãàÏóò"]],
      ["david", ["Îç∞Ïù¥ÎπÑÎìú"]],
      ["diana", ["Îã§Ïù¥Ïï†ÎÇò"]],
      ["dylan", ["ÎîúÎü∞"]],
      ["edward", ["ÏóêÎìúÏõåÎìú"]],
      ["elijah", ["ÏùºÎùºÏù¥Ï†Ä"]],
      ["elizabeth", ["ÏóòÎ¶¨ÏûêÎ≤†Ïä§"]],
      ["ella", ["ÏóòÎùº"]],
      ["elliot", ["ÏóòÎ¶¨Ïóá"]],
      ["emily", ["ÏóêÎ∞ÄÎ¶¨"]],
      ["emma", ["Ïó†Îßà"]],
      ["eric", ["ÏóêÎ¶≠"]],
      ["ethan", ["Ïù¥ÏÑ†"]],
      ["eugene", ["Ïú†ÏßÑ"]],
      ["felix", ["Ìé†Î¶≠Ïä§"]],
      ["frank", ["ÌîÑÎû≠ÌÅ¨"]],
      ["gabriel", ["Í∞ÄÎ∏åÎ¶¨Ïóò"]],
      ["geoff", ["Ï†úÌîÑ"]],
      ["geoffrey", ["Ï†úÌîÑÎ¶¨"]],
      ["george", ["Ï°∞ÏßÄ"]],
      ["grace", ["Í∑∏Î†àÏù¥Ïä§"]],
      ["hannah", ["ÌïúÎÇò"]],
      ["harriet", ["Ìï¥Î¶¨Ïóá"]],
      ["harry", ["Ìï¥Î¶¨"]],
      ["helen", ["Ìó¨Î†å"]],
      ["henry", ["Ìó®Î¶¨"]],
      ["hudson", ["ÌóàÎìúÏä®"]],
      ["isaac", ["ÏïÑÏù¥Ïûë","Ïù¥ÏÇ≠"]],
      ["isabella", ["Ïù¥ÏÇ¨Î≤®Îùº"]],
      ["isabelle", ["Ïù¥ÏÇ¨Î≤®"]],
      ["jack", ["Ïû≠"]],
      ["jackson", ["Ïû≠Ïä®","Ïû¨Ïª§Ïä®"]],
      ["jacob", ["Ï†úÏù¥ÏΩ•"]],
      ["james", ["Ï†úÏûÑÏä§"]],
      ["jane", ["Ï†úÏù∏"]],
      ["janet", ["Ïû¨Îãõ"]],
      ["jason", ["Ï†úÏù¥Ïä®"]],
      ["jennifer", ["Ï†úÎãàÌçº"]],
      ["jeremy", ["Ï†úÎü¨ÎØ∏"]],
      ["jerry", ["Ï†úÎ¶¨"]],
      ["jessica", ["Ï†úÏãúÏπ¥"]],
      ["joel", ["Ï°∞Ïóò"]],
      ["john", ["Ï°¥"]],
      ["joseph", ["Ï°∞ÏÖâ"]],
      ["joshua", ["Ï°∞ÏäàÏïÑ"]],
      ["julia", ["Ï§ÑÎ¶¨ÏïÑ"]],
      ["justin", ["Ï†ÄÏä§Ìã¥"]],
      ["karen", ["Ï∫êÎü∞"]],
      ["katherine", ["Ï∫êÏÑúÎ¶∞"]],
      ["kathryn", ["Ï∫êÏÑúÎ¶∞"]],
      ["katie", ["ÏºÄÏù¥Ìã∞"]],
      ["kevin", ["ÏºÄÎπà"]],
      ["kylie", ["Ïπ¥ÏùºÎ¶¨"]],
      ["laura", ["Î°úÎùº"]],
      ["lauren", ["Î°úÎü∞"]],
      ["leo", ["Î†àÏò§"]],
      ["liam", ["Î¶¨Ïïî"]],
      ["linda", ["Î¶∞Îã§"]],
      ["lisa", ["Î¶¨ÏÇ¨"]],
      ["lucas", ["Î£®Ïπ¥Ïä§"]],
      ["lucy", ["Î£®Ïãú"]],
      ["maria", ["ÎßàÎ¶¨ÏïÑ"]],
      ["mark", ["ÎßàÌÅ¨"]],
      ["martin", ["ÎßàÌã¥"]],
      ["mary", ["Î©îÎ¶¨"]],
      ["mason", ["Î©îÏù¥Ïä®"]],
      ["matt", ["Îß∑"]],
      ["matthew", ["Îß§Ìäú"]],
      ["may", ["Î©îÏù¥"]],
      ["megan", ["Î©îÍ±¥"]],
      ["mia", ["ÎØ∏ÏïÑ"]],
      ["michael", ["ÎßàÏù¥ÌÅ¥"]],
      ["michelle", ["ÎØ∏ÏÖ∏"]],
      ["morgan", ["Î™®Í±¥"]],
      ["natalie", ["ÎÇòÌÉàÎ¶¨"]],
      ["nathan", ["ÎÑ§Ïù¥ÏÑ†"]],
      ["nicholas", ["ÎãàÏΩúÎùºÏä§"]],
      ["nicolas", ["ÎãàÏΩúÎùºÏä§"]],
      ["nicole", ["ÎãàÏΩú"]],
      ["noah", ["ÎÖ∏ÏïÑ"]],
      ["oliver", ["Ïò¨Î¶¨Î≤Ñ"]],
      ["olivia", ["Ïò¨Î¶¨ÎπÑÏïÑ"]],
      ["owen", ["Ïò§Ïõ¨"]],
      ["paul", ["Ìè¥"]],
      ["peter", ["ÌîºÌÑ∞"]],
      ["rachel", ["Î†àÏù¥Ï≤º"]],
      ["rebecca", ["Î†àÎ≤†Ïπ¥"]],
      ["richard", ["Î¶¨Ï≤òÎìú"]],
      ["robert", ["Î°úÎ≤ÑÌä∏"]],
      ["ryan", ["ÎùºÏù¥Ïñ∏"]],
      ["samuel", ["ÏÉàÎÆ§Ïñº"]],
      ["sarah", ["ÏÇ¨Îùº"]],
      ["sean", ["ÏÖò"]],
      ["shawn", ["ÏÖò"]],
      ["simon", ["ÏÇ¨Ïù¥Î®º"]],
      ["sophia", ["ÏÜåÌîºÏïÑ"]],
      ["sora", ["ÏÜåÎùº"]],
      ["stephen", ["Ïä§Ìã∞Î∏ê"]],
      ["steven", ["Ïä§Ìã∞Î∏ê"]],
      ["taylor", ["ÌÖåÏùºÎü¨"]],
      ["thomas", ["ÌÜ†Î®∏Ïä§","ÌÜ†ÎßàÏä§"]],
      ["victoria", ["ÎπÖÌÜ†Î¶¨ÏïÑ"]],
      ["william", ["ÏúåÎ¶¨ÏóÑ","ÏúåÎ¶¨Ïïî"]],
      ["zoe", ["Ï°∞Ïù¥"]]
    ]);

    // ------------------------------
    // DOM
    // ------------------------------
    const $ = (s) => document.querySelector(s);
    const nameInput = $("#nameInput");
    const resultsEl = $("#results");
    const toast = $("#toast");
    const communityList = $("#communityList");
    const hangulNameEl = $("#hangulName");
    const hangulDisplayEl = $("#hangulDisplay");
    const englishNameEl = $("#englishName");
    const saveIdBtn = $("#saveIdBtn");
    const practiceToggle = $("#practiceToggle");
    const practicePanel = $("#practicePanel");
    const syllableList = $("#syllableList");
    const jamoGuideList = $("#jamoGuideList");
    const printPracticeBtn = $("#printPracticeBtn");

    const suggestKey = $("#suggestKey");
    const suggestHangul = $("#suggestHangul");
    const submitSuggestionBtn = $("#submitSuggestionBtn");
    const communityOpenBtn = $("#communityOpenBtn");
    const communityModal = $("#communityModal");
    const communityCloseBtn = $("#communityCloseBtn");
    const communityNav = $("#communityNav");

    $("#year").textContent = new Date().getFullYear();

    function openCommunity() {
      communityModal.classList.add("open");
      communityModal.setAttribute("aria-hidden", "false");
      setTimeout(() => suggestKey?.focus(), 0);
    }

    function closeCommunity() {
      communityModal.classList.remove("open");
      communityModal.setAttribute("aria-hidden", "true");
    }

    communityOpenBtn?.addEventListener("click", openCommunity);
    communityNav?.addEventListener("click", (e) => {
      e.preventDefault();
      openCommunity();
    });
    communityCloseBtn?.addEventListener("click", closeCommunity);
    communityModal?.addEventListener("click", (e) => {
      if (e.target === communityModal) closeCommunity();
    });
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && communityModal.classList.contains("open")) {
        closeCommunity();
      }
    });

    function setCardValues(hangul, english) {
      if (hangulNameEl) hangulNameEl.textContent = hangul || "‚Äî";
      if (hangulDisplayEl) hangulDisplayEl.textContent = hangul || "‚Äî";
      if (englishNameEl) englishNameEl.textContent = english || "English Name";
    }

    function setPracticeVisibility(show) {
      if (!practiceToggle || !practicePanel) return;
      practiceToggle.style.display = show ? "inline-flex" : "none";
      if (!show) {
        practicePanel.hidden = true;
        practiceToggle.setAttribute("aria-expanded", "false");
      }
    }

    function resetPracticePanel() {
      if (practicePanel) practicePanel.hidden = true;
      if (practiceToggle) practiceToggle.setAttribute("aria-expanded", "false");
      if (syllableList) syllableList.innerHTML = "";
      if (jamoGuideList) jamoGuideList.innerHTML = "";
    }

    setPracticeVisibility(false);

    async function captureIDCard() {
      const card = document.getElementById("idCard");
      if (!card) throw new Error("idCard not found");
      const canvas = await html2canvas(card, {
        backgroundColor: null,
        scale: Math.min(window.devicePixelRatio || 1, 2),
        useCORS: true
      });
      return new Promise((resolve) => {
        canvas.toBlob((blob) => resolve(blob), "image/png", 0.95);
      });
    }

    async function downloadIDCard() {
      try {
        const blob = await captureIDCard();
        if (!blob) throw new Error("capture failed");
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "honorary-korean-id.png";
        a.click();
        URL.revokeObjectURL(url);
      } catch {}
    }

    saveIdBtn?.addEventListener("click", downloadIDCard);

    let currentUser = null;
    let authReadyResolve;
    const authReady = new Promise((resolve) => { authReadyResolve = resolve; });
    let lastNameKey = "";
    let lastRecommended = "";
    let lastSource = "";
    let lastSuggestionTs = 0;
    let canonicalCache = new Map();

    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      if (user) authReadyResolve?.();
      if (!user) {
        signInAnonymously(auth).catch(() => {});
      }
    });

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }

    function showToast(msg="Copied!") {
      toast.textContent = msg;
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 900);
    }

    async function copyText(t) {
      try {
        await navigator.clipboard.writeText(t);
        showToast("Copied!");
      } catch {
        const ta = document.createElement("textarea");
        ta.value = t;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
        showToast("Copied!");
      }
    }

    const clearBtn = $("#clearBtn");
    if (clearBtn) {
      clearBtn.addEventListener("click", () => {
        nameInput.value = "";
        setCardValues("‚Äî", "English Name");
        setPracticeVisibility(false);
        communityList.innerHTML = "";
        suggestKey.value = "";
        suggestHangul.value = "";
        nameInput.focus();
      });
    }

    // ------------------------------
    // Normalizers
    // ------------------------------
    function normalizeEnglishKey(s) {
      return (s || "")
        .trim()
        .toLowerCase()
        .replace(/[^a-z\s'-]/g, "")
        .replace(/\s+/g, " ")
        .trim();
    }

    function normalizeHangulValue(s) {
      return (s || "").trim().replace(/\s+/g, " ").trim();
    }


    // ------------------------------
    // Rule-based fallback
    // ------------------------------
    const CHO  = ["„Ñ±","„Ñ≤","„Ñ¥","„Ñ∑","„Ñ∏","„Ñπ","„ÖÅ","„ÖÇ","„ÖÉ","„ÖÖ","„ÖÜ","„Öá","„Öà","„Öâ","„Öä","„Öã","„Öå","„Öç","„Öé"];
    const JUNG = ["„Öè","„Öê","„Öë","„Öí","„Öì","„Öî","„Öï","„Öñ","„Öó","„Öò","„Öô","„Öö","„Öõ","„Öú","„Öù","„Öû","„Öü","„Ö†","„Ö°","„Ö¢","„Ö£"];
    const JONG = ["", "„Ñ±","„Ñ≤","„Ñ≥","„Ñ¥","„Ñµ","„Ñ∂","„Ñ∑","„Ñπ","„Ñ∫","„Ñª","„Ñº","„ÑΩ","„Ñæ","„Ñø","„ÖÄ","„ÖÅ","„ÖÇ","„ÖÑ","„ÖÖ","„ÖÜ","„Öá","„Öà","„Öä","„Öã","„Öå","„Öç","„Öé"];
    const choIndex  = Object.fromEntries(CHO.map((c,i)=>[c,i]));
    const jungIndex = Object.fromEntries(JUNG.map((c,i)=>[c,i]));
    const jongIndex = Object.fromEntries(JONG.map((c,i)=>[c,i]));

    function composeSyllable(cho, jung, jong="") {
      if (!(cho in choIndex)) cho = "„Öá";
      if (!(jung in jungIndex)) jung = "„Öè";
      if (!(jong in jongIndex)) jong = "";
      const base = 0xAC00;
      const code = base + (choIndex[cho] * 21 * 28) + (jungIndex[jung] * 28) + jongIndex[jong];
      return String.fromCharCode(code);
    }

    const VOWELS = [
      ["eigh","ÏóêÏù¥"], ["igh","ÏïÑÏù¥"],
      ["eau","Ïò§"], ["ieu","Ïú†"],
      ["ai","ÏóêÏù¥"], ["ay","ÏóêÏù¥"],
      ["air","ÏóêÏñ¥"], ["ear","Ïù¥Ïñ¥"],
      ["are","ÏóêÏñ¥"], ["ere","Ïù¥Ïñ¥"],
      ["eer","Ïù¥Ïñ¥"], ["ier","Ïù¥Ïñ¥"],
      ["er","Ïñ¥"], ["ir","Ïñ¥"], ["ur","Ïñ¥"],
      ["ar","ÏïÑ"], ["or","Ïò§"],
      ["ea","Ïù¥"], ["ee","Ïù¥"], ["ie","Ïù¥"], ["ei","Ïù¥"],
      ["ew","Ïú†"], ["ui","ÏúÑ"], ["ue","Ïú†"], ["eu","Ïú†"],
      ["oo","Ïö∞"], ["ow","ÏïÑÏö∞"], ["ou","ÏïÑÏö∞"],
      ["au","Ïò§"], ["aw","Ïò§"],
      ["oi","Ïò§Ïù¥"], ["oy","Ïò§Ïù¥"],
      ["oa","Ïò§"], ["oe","Ïò§"],
      ["a","ÏïÑ"], ["e","Ïóê"], ["i","Ïù¥"], ["o","Ïò§"], ["u","Ïö∞"], ["y","Ïù¥"]
    ];

    const CONS = [
      ["tch","„Öä"], ["dge","„Öà"], ["dg","„Öà"],
      ["ch","„Öä"], ["sh","„ÖÖ"], ["ph","„Öç"],
      ["th","„Öå"], ["ck","„Öã"], ["ng","„Öá"], ["qu","„Öã"], ["wh","„Öé"],
      ["kn","„Ñ¥"], ["wr","„Ñπ"], ["gn","„Ñ¥"], ["ps","„ÖÖ"], ["x","„Öã„ÖÖ"],
      ["c","„Öã"], ["g","„Ñ±"], ["k","„Öã"], ["j","„Öà"], ["q","„Öã"],
      ["r","„Ñπ"], ["l","„Ñπ"], ["m","„ÖÅ"], ["n","„Ñ¥"], ["b","„ÖÇ"], ["p","„Öç"],
      ["d","„Ñ∑"], ["t","„Öå"], ["f","„Öç"], ["v","„ÖÇ"], ["h","„Öé"], ["s","„ÖÖ"], ["z","„Öà"], ["w","„Öá"],
    ];

    function tokenize(word) {
      let s = word.toLowerCase();
      const out = [];
      let i = 0;
      const isVowelLetter = (ch) => "aeiouy".includes(ch || "");
      while (i < s.length) {
        const ch = s[i];
        if (ch === "'" || ch === "-") { i++; continue; }

        if (s.startsWith("gh", i) && i > 0 && isVowelLetter(s[i - 1]) && !isVowelLetter(s[i + 2])) {
          i += 2; continue; // silent "gh" in words like "night"
        }

        if (s[i] === "c" && (s[i+1] === "e" || s[i+1] === "i" || s[i+1] === "y")) {
          out.push({type:"C", val:"„ÖÖ"}); i += 1; continue;
        }

        let matched = false;

        for (const [pat, val] of VOWELS) {
          if (s.startsWith(pat, i)) { out.push({type:"V", val}); i += pat.length; matched = true; break; }
        }
        if (matched) continue;

        for (const [pat, val] of CONS) {
          if (s.startsWith(pat, i)) { out.push({type:"C", val, raw: pat}); i += pat.length; matched = true; break; }
        }
        if (matched) continue;

        i++;
      }
      return out;
    }

    function pickJung(vowelSyllables) {
      const map = [
        ["ÏïÑ","„Öè"], ["Ïï†","„Öê"], ["Ïïº","„Öë"], ["Ïòà","„Öñ"], ["Ïóê","„Öî"],
        ["Ïñ¥","„Öì"], ["Ïó¨","„Öï"],
        ["Ïò§","„Öó"], ["ÏôÄ","„Öò"], ["Ïôú","„Öô"], ["Ïô∏","„Öö"],
        ["Ïö∞","„Öú"], ["Ïõå","„Öù"], ["Ïõ®","„Öû"], ["ÏúÑ","„Öü"],
        ["Ïú†","„Ö†"], ["Ïúº","„Ö°"], ["Ïùò","„Ö¢"], ["Ïù¥","„Ö£"],
      ];
      for (const [k,v] of map) if (vowelSyllables.startsWith(k)) return v;
      return "„Öè";
    }

    function splitHangulSyllables(s) {
      const out = [];
      for (const ch of (s || "")) out.push(ch);
      return out.length ? out : [s];
    }

    function toJong(consonantJamo) {
      const last = consonantJamo.slice(-1);
      if (JONG.includes(last)) return last;
      const close = {"„Öç":"„ÖÇ","„Öã":"„Ñ±","„Öä":"„Öà","„Öå":"„Ñ∑","„ÖÜ":"„ÖÖ"};
      return (close[last] && JONG.includes(close[last])) ? close[last] : "";
    }

    function toCho(consonantJamo) {
      const first = consonantJamo[0];
      if (CHO.includes(first)) return first;
      const close = {"„Öç":"„ÖÇ","„Öã":"„Ñ±","„Öä":"„Öà","„Öå":"„Ñ∑","„ÖÜ":"„ÖÖ"};
      return (close[first] && CHO.includes(close[first])) ? close[first] : "„Öá";
    }

    const SUFFIX_MAP = [
      ["tious","ÏÖîÏä§"],
      ["cious","ÏÖîÏä§"],
      ["tion","ÏÖò"],
      ["sion","ÏÖò"],
      ["cion","ÏÖò"],
      ["tial","ÏÖú"],
      ["cial","ÏÖú"],
      ["ture","Ï≤ò"],
      ["sure","ÏÖî"],
      ["tia","ÏãúÏïÑ"],
      ["cia","ÏãúÏïÑ"],
      ["sia","ÏãúÏïÑ"],
      ["tio","ÏãúÏò§"],
      ["cio","ÏãúÏò§"],
      ["sio","ÏãúÏò§"],
      ["ment","Î®ºÌä∏"],
      ["ness","ÎãàÏä§"],
      ["able","ÏóêÏù¥Î∏î"],
      ["ible","Ïù¥Î∏î"],
      ["son","Ïä®"],
      ["sen","Ïä®"],
      ["ton","ÌÑ¥"],
      ["man","Îß®"],
      ["men","Îß®"],
      ["lynne","Î¶∞"],
      ["line","ÎùºÏù∏"],
      ["lyn","Î¶∞"],
      ["ette","ÏóêÌä∏"]
    ];

    function splitSuffix(word) {
      for (const [suf, hangul] of SUFFIX_MAP) {
        if (word.length > suf.length && word.endsWith(suf)) {
          return { base: word.slice(0, -suf.length), suffix: hangul };
        }
      }
      return { base: word, suffix: "" };
    }

    function ruleBasedHangul(word) {
      const { base, suffix } = splitSuffix(word);
      const tokens = tokenize(base);
      if (!tokens.length) return suffix || "";
      let res = "";
      let i = 0;
      while (i < tokens.length) {
        let cho = "„Öá";
        if (tokens[i]?.type === "C") { cho = toCho(tokens[i].val); i++; }
        if (tokens[i]?.type !== "V") break;
        const vowelSylls = splitHangulSyllables(tokens[i].val);
        i++;

        let pendingFinal = false;
        let finalCon = null;
        if (tokens[i]?.type === "C" && tokens[i+1]?.type !== "V") {
          pendingFinal = true;
          finalCon = tokens[i];
          i++;
        }

        const firstJung = pickJung(vowelSylls[0]);
        if (vowelSylls.length === 1) {
          let jong = "";
          if (pendingFinal) {
            if (finalCon?.raw === "x") {
              jong = "„Ñ±";
              res += composeSyllable(cho, firstJung, jong) + "Ïä§";
              continue;
            }
            jong = toJong(finalCon.val);
          }
          res += composeSyllable(cho, firstJung, jong);
          continue;
        }

        res += composeSyllable(cho, firstJung, "");
        for (let s = 1; s < vowelSylls.length; s++) {
          const isLast = s === vowelSylls.length - 1;
          let jong = "";
          if (isLast && pendingFinal) {
            if (finalCon?.raw === "x") {
              jong = "„Ñ±";
              res += composeSyllable("„Öá", pickJung(vowelSylls[s]), jong) + "Ïä§";
              break;
            }
            jong = toJong(finalCon.val);
          }
          res += composeSyllable("„Öá", pickJung(vowelSylls[s]), jong);
        }
      }
      return res + suffix;
    }

    // ------------------------------
    // Firestore helpers
    // ------------------------------
    async function getCanonical(nameKey) {
      if (canonicalCache.has(nameKey)) return canonicalCache.get(nameKey);
      try {
        const snap = await getDoc(doc(db, "canonical", nameKey));
        if (snap.exists()) {
          const data = snap.data();
          canonicalCache.set(nameKey, data);
          return data;
        }
      } catch {}
      return null;
    }

    async function fetchCommunitySuggestions(nameKey) {
      communityList.innerHTML = "";
      if (!nameKey) return;
      const q = query(
        collection(db, "suggestions"),
        where("nameKey", "==", nameKey),
        where("status", "in", ["approved", "pending"]),
        orderBy("score", "desc"),
        orderBy("reportCount", "asc"),
        orderBy("createdAt", "desc"),
        limit(8)
      );
      const snap = await getDocs(q);
      if (snap.empty) {
        communityList.innerHTML = `<div class="muted" style="margin-top:8px;">No suggestions yet.</div>`;
        return;
      }
      snap.forEach((docSnap) => {
        const s = docSnap.data();
        const row = document.createElement("div");
        row.className = "community-item";
        row.innerHTML = `
          <div>
            <div class="hangul">${escapeHtml(s.hangul)}</div>
            <div class="meta">
              <span class="mini-badge">Score ${s.score ?? 0}</span>
              <span class="mini-badge">Reports ${s.reportCount ?? 0}</span>
              <span class="mini-badge ${s.status === "approved" ? "badge-ok" : "badge-warn"}">${s.status === "approved" ? "Approved" : "Pending review"}</span>
            </div>
          </div>
          <div class="row" style="margin:0">
            <button class="btn" data-vote="up" data-id="${docSnap.id}">üëç</button>
            <button class="btn" data-vote="down" data-id="${docSnap.id}">üëé</button>
            <button class="btn" data-report="true" data-id="${docSnap.id}">Report</button>
          </div>
        `;
        communityList.appendChild(row);
      });
    }

    function isValidHangul(s) {
      return /[Í∞Ä-Ìû£]/.test(s || "");
    }

    function withinLimits(nameKey, hangul) {
      return nameKey.length >= 2 && nameKey.length <= 40 && hangul.length >= 1 && hangul.length <= 20;
    }

    function throttleSuggestion() {
      const now = Date.now();
      if (now - lastSuggestionTs < 10000) return false;
      lastSuggestionTs = now;
      return true;
    }

    async function submitSuggestion(nameKey, hangul) {
      if (!currentUser) {
        showToast("Signing in...");
        await authReady.catch(() => {});
      }
      if (!currentUser) { showToast("Auth not ready"); return; }
      if (!isValidHangul(hangul)) { showToast("Hangul required"); return; }
      if (!withinLimits(nameKey, hangul)) { showToast("Length out of range"); return; }

      const canonical = await getCanonical(nameKey);
      if (canonical && canonical.hangulBest === hangul) {
        showToast("Already official");
        return;
      }

      if (!throttleSuggestion()) {
        showToast("Please wait 10s before submitting again");
        return;
      }

      // If duplicate suggestion exists, upvote it instead of creating a new doc.
      const dupQ = query(
        collection(db, "suggestions"),
        where("nameKey", "==", nameKey),
        where("hangul", "==", hangul),
        where("status", "in", ["pending", "approved"]),
        limit(1)
      );
      const dupSnap = await getDocs(dupQ);
      if (!dupSnap.empty) {
        const dupDoc = dupSnap.docs[0];
        await voteSuggestion(nameKey, dupDoc.id, 1);
        showToast("Voted existing suggestion");
        return;
      }

      const suggestionId = crypto.randomUUID();
      await setDoc(doc(db, "suggestions", suggestionId), {
        nameKey,
        hangul,
        status: "pending",
        votesUp: 1,
        votesDown: 0,
        score: 1,
        reportCount: 0,
        createdAt: serverTimestamp(),
        createdBy: currentUser.uid
      });

      await setDoc(doc(db, "votes", `${nameKey}_${currentUser.uid}`), {
        nameKey,
        suggestionId,
        vote: 1
      });

      showToast("Submitted for review");
      await fetchCommunitySuggestions(nameKey);
    }

    async function voteSuggestion(nameKey, suggestionId, vote) {
      if (!currentUser) { showToast("Signing in..."); return; }
      const voteId = `${nameKey}_${currentUser.uid}`;
      const voteRef = doc(db, "votes", voteId);
      await runTransaction(db, async (tx) => {
        const existingVote = await tx.get(voteRef);
        if (existingVote.exists()) return;
        const suggestionRef = doc(db, "suggestions", suggestionId);
        const suggestionSnap = await tx.get(suggestionRef);
        if (!suggestionSnap.exists()) return;

        const data = suggestionSnap.data();
        const up = (data.votesUp || 0) + (vote === 1 ? 1 : 0);
        const down = (data.votesDown || 0) + (vote === -1 ? 1 : 0);
        tx.update(suggestionRef, {
          votesUp: up,
          votesDown: down,
          score: up - down
        });
        tx.set(voteRef, { nameKey, suggestionId, vote });
      });
      await fetchCommunitySuggestions(nameKey);
    }

    async function reportSuggestion(nameKey, suggestionId) {
      if (!currentUser) { showToast("Signing in..."); return; }
      const reportId = `${suggestionId}_${currentUser.uid}`;
      const reportRef = doc(db, "reports", reportId);
      await runTransaction(db, async (tx) => {
        const existingReport = await tx.get(reportRef);
        if (existingReport.exists()) return;
        const suggestionRef = doc(db, "suggestions", suggestionId);
        const suggestionSnap = await tx.get(suggestionRef);
        if (!suggestionSnap.exists()) return;
        const data = suggestionSnap.data();
        tx.update(suggestionRef, { reportCount: (data.reportCount || 0) + 1 });
        tx.set(reportRef, { suggestionId, nameKey });
      });
      showToast("Reported");
      await fetchCommunitySuggestions(nameKey);
    }

    // ------------------------------
    // Lookup order: local > canonical > built-in > rule
    // ------------------------------
    async function lookupOneWord(wordLower) {
      const canonical = await getCanonical(wordLower);
      if (canonical?.hangulBest) {
        const alts = Array.isArray(canonical.alts) ? canonical.alts : [];
        return { options: [canonical.hangulBest, ...alts].filter(Boolean).slice(0,3), source: "canonical" };
      }

      if (BUILTIN_DICT.has(wordLower)) return { options: BUILTIN_DICT.get(wordLower), source: "builtin" };

      const base = ruleBasedHangul(wordLower);
      let thVariant = "";
      if (wordLower.includes("th")) thVariant = ruleBasedHangul(wordLower.replaceAll("th", "s"));
      const opts = [base, thVariant].filter(Boolean);
      return { options: [...new Set(opts)].slice(0, 3), source: "rule" };
    }

    function sourceLabel(src){
      if (src === "canonical") return "Canonical";
      if (src === "builtin") return "Built-in dictionary";
      return "Rule-based fallback";
    }

    async function renderResults(rawInput, wordResults, combinedOptions, combinedSource) {
      if (!combinedOptions.length) {
        setCardValues("‚Äî", rawInput || "English Name");
        setPracticeVisibility(false);
        return;
      }

      const primary = combinedOptions[0];
      setCardValues(primary, rawInput);
      setPracticeVisibility(true);
    }

    async function convert() {
      const raw = nameInput.value.trim();
      if (!raw) { setCardValues("‚Äî", "English Name"); setPracticeVisibility(false); return; }

      const cleaned = raw
        .replace(/[^a-zA-Z\s'-]/g, "")
        .replace(/\s+/g, " ")
        .trim();

      if (!cleaned) { setCardValues("‚Äî", raw); setPracticeVisibility(false); return; }

      resetPracticePanel();

      const words = cleaned.split(" ").map(w => w.trim()).filter(Boolean);
      const wordResults = [];
      for (const w of words) {
        const key = normalizeEnglishKey(w);
        const res = await lookupOneWord(key);
        wordResults.push({ word: w, key, options: res.options, source: res.source });
      }

      const combined = [];
      for (let i = 0; i < 3; i++) {
        const parts = wordResults.map(wr => wr.options[i] || wr.options[0]).filter(Boolean);
        if (parts.length) combined.push(parts.join(" "));
      }
      const combinedOptions = [...new Set(combined)].slice(0, 3);

      const anyCanonical = wordResults.some(w => w.source === "canonical");
      const allBuiltin = wordResults.every(w => w.source === "builtin");
      const combinedSource = anyCanonical ? "canonical" : (allBuiltin ? "builtin" : "rule");

      await renderResults(raw, wordResults, combinedOptions, combinedSource);

      lastNameKey = normalizeEnglishKey(raw);
      lastRecommended = combinedOptions[0] || "";
      lastSource = combinedSource;
      suggestKey.value = lastNameKey;
      suggestHangul.value = lastRecommended;

      const firstKey = wordResults[0]?.key || "";
      if (firstKey) {
        fetchCommunitySuggestions(firstKey).catch(() => {});
      }
    }

    $("#convertBtn").addEventListener("click", convert);
    nameInput.addEventListener("keydown", (e) => { if (e.key === "Enter") convert(); });

    function setSuggestionFromOutput(en, ko) {
      suggestKey.value = normalizeEnglishKey(en);
      suggestHangul.value = ko;
      openCommunity();
    }

    submitSuggestionBtn.addEventListener("click", () => {
      const key = normalizeEnglishKey(suggestKey.value || nameInput.value);
      const hangul = normalizeHangulValue(suggestHangul.value);
      if (!key || key.length < 2) { showToast("Enter an English name"); return; }
      if (!hangul) { showToast("Enter a Hangul spelling"); return; }
      const isKnownSource = (lastSource === "custom" || lastSource === "canonical" || lastSource === "builtin");
      if (isKnownSource && key === lastNameKey && hangul === lastRecommended) {
        showToast("Already official. No suggestion needed.");
        return;
      }
      submitSuggestion(key, hangul).catch((err) => {
        console.error("submitSuggestion failed", err);
        showToast(err?.message ? `Failed: ${err.message}` : "Failed to submit");
      });
    });

    communityList.addEventListener("click", (e) => {
      const btn = e.target.closest("button");
      if (!btn) return;
      const suggestionId = btn.getAttribute("data-id");
      if (!suggestionId) return;
      const nameKey = normalizeEnglishKey(suggestKey.value || nameInput.value);
      if (btn.getAttribute("data-vote") === "up") {
        voteSuggestion(nameKey, suggestionId, 1).catch(() => showToast("Vote failed"));
      } else if (btn.getAttribute("data-vote") === "down") {
        voteSuggestion(nameKey, suggestionId, -1).catch(() => showToast("Vote failed"));
      } else if (btn.getAttribute("data-report")) {
        reportSuggestion(nameKey, suggestionId).catch(() => showToast("Report failed"));
      }
    });

    // ------------------------------
    // Writing practice helpers
    // ------------------------------
    const JAMO_GUIDE = {
      "„Ñ±": ["Down stroke", "Short stroke to the right"],
      "„Ñ¥": ["Down stroke", "Bottom stroke to the right"],
      "„Ñ∑": ["Top stroke", "Down stroke", "Bottom stroke to the right"],
      "„Ñπ": ["Top stroke", "Down stroke", "Middle stroke", "Bottom stroke"],
      "„ÖÅ": ["Top stroke", "Left down", "Bottom stroke", "Right up"],
      "„ÖÇ": ["Left down", "Bottom stroke", "Right up", "Top stroke", "Middle stroke"],
      "„ÖÖ": ["Left slant", "Right slant"],
      "„Öá": ["Draw a circle"],
      "„Öà": ["Left slant", "Right slant", "Top stroke"],
      "„Öä": ["Left slant", "Right slant", "Top stroke", "Extra top stroke"],
      "„Öã": ["Top stroke", "Down stroke", "Middle short stroke"],
      "„Öå": ["Top stroke", "Middle stroke", "Down stroke", "Bottom stroke"],
      "„Öç": ["Top stroke", "Left down", "Bottom stroke", "Right up", "Middle stroke"],
      "„Öé": ["Top stroke", "Middle short stroke", "Draw a circle below"],
      "„Öè": ["Long vertical stroke", "Short stroke to the right (middle)"],
      "„Öì": ["Long vertical stroke", "Short stroke to the right (middle)"],
      "„Öó": ["Long horizontal stroke", "Short stroke up (middle)"],
      "„Öú": ["Long horizontal stroke", "Short stroke down (middle)"],
      "„Ö°": ["Long horizontal stroke"],
      "„Ö£": ["Long vertical stroke"],
      "„Öê": ["Long vertical stroke", "Short stroke to the right (middle)", "Add a short vertical stroke"],
      "„Öî": ["Long vertical stroke", "Short stroke to the right (middle)", "Add a short horizontal stroke"]
    };

    function decomposeHangulSyllable(ch) {
      const code = ch.charCodeAt(0);
      const base = 0xAC00;
      const end = 0xD7A3;
      if (code < base || code > end) return null;
      const sIndex = code - base;
      const cho = CHO[Math.floor(sIndex / 588)];
      const jung = JUNG[Math.floor((sIndex % 588) / 28)];
      const jongIndex = sIndex % 28;
      const jong = JONG[jongIndex] || "";
      return { cho, jung, jong };
    }

    function getJamoGuide(jamo) {
      return JAMO_GUIDE[jamo] || ["Guide coming soon for this character."];
    }

    function updatePracticeUI(hangulText) {
      if (!hangulText || hangulText === "‚Äî") return;
      if (!syllableList || !jamoGuideList) return;

      const chars = Array.from(hangulText.replace(/\s+/g, ""));
      const jamoSet = new Set();
      syllableList.innerHTML = "";
      jamoGuideList.innerHTML = "";

      for (const ch of chars) {
        const parts = decomposeHangulSyllable(ch);
        if (!parts) continue;
        const jamos = [parts.cho, parts.jung, parts.jong].filter(Boolean);
        jamos.forEach(j => jamoSet.add(j));

        const item = document.createElement("div");
        item.className = "syllable-item";
        item.innerHTML = `
          <div class="syllable">${ch}</div>
          <div class="jamo">${jamos.join(" + ")}</div>
        `;
        syllableList.appendChild(item);
      }

      Array.from(jamoSet).forEach((jamo) => {
        const steps = getJamoGuide(jamo);
        const row = document.createElement("div");
        row.className = "jamo-row";
        row.innerHTML = `
          <div><span class="label">${jamo}</span></div>
          <div class="steps">${steps.map((s, i) => `${i + 1}) ${s}`).join("  ")}</div>
        `;
        jamoGuideList.appendChild(row);
      });
    }

    function openPracticeSheetPrintWindow(hangulText) {
      const safeText = (hangulText || "").trim();
      if (!safeText || safeText === "‚Äî") return;
      const traceCount = 8;
      const rows = 4;
      const cols = 6;
      const total = rows * cols;
      const cells = Array.from({ length: total }, (_, i) => {
        const trace = i < traceCount ? `<span class="trace">${safeText}</span>` : "";
        return `<div class="cell">${trace}</div>`;
      }).join("");

      const win = window.open("", "_blank", "width=900,height=700");
      if (!win) return;
      win.document.write(`<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hangul Name Practice Sheet</title>
  <style>
    *{box-sizing:border-box}
    body{margin:24px;font-family: "Nanum Myeongjo", serif;color:#1b1b1b;}
    h1{margin:0 0 6px;font-size:22px;}
    .name{font-size:40px;margin:6px 0 18px;font-weight:700;letter-spacing:.06em;}
    .grid{display:grid;grid-template-columns:repeat(${cols}, minmax(0,1fr));gap:8px;}
    .cell{aspect-ratio:1/1;border:1px solid #cfc9bf;position:relative;}
    .cell::before,.cell::after{
      content:"";position:absolute;left:50%;top:0;bottom:0;width:1px;background:#e9e4dc;
      transform:translateX(-50%);
    }
    .cell::after{left:0;right:0;top:50%;height:1px;width:auto;transform:translateY(-50%);}
    .trace{
      position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
      font-size:24px;color:rgba(0,0,0,.12);letter-spacing:.06em;
    }
    footer{margin-top:18px;font-size:11px;color:#8a8177;}
    @media print{
      body{margin:16mm;}
      .print-btn{display:none;}
    }
  </style>
</head>
<body>
  <button class="print-btn" onclick="window.print()">Print</button>
  <h1>Hangul Name Practice Sheet</h1>
  <div class="name">${safeText}</div>
  <div class="grid">${cells}</div>
  <footer>Generated by Hangul Name Studio</footer>
</body>
</html>`);
      win.document.close();
      win.focus();
      setTimeout(() => win.print(), 400);
    }

    practiceToggle?.addEventListener("click", () => {
      if (!practicePanel) return;
      const open = practicePanel.hidden;
      practicePanel.hidden = !open;
      practiceToggle.setAttribute("aria-expanded", open ? "true" : "false");
      if (open) {
        updatePracticeUI(hangulDisplayEl?.textContent || "");
      }
    });

    printPracticeBtn?.addEventListener("click", () => {
      openPracticeSheetPrintWindow(hangulDisplayEl?.textContent || "");
    });

    nameInput.focus();
  </script>
</body>
</html>
