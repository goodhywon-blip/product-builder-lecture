rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isAdmin() {
      return request.auth != null && request.auth.uid == "PASTE_ADMIN_UID_HERE";
    }

    function isValidNameKey(nameKey) {
      return nameKey is string && nameKey.size() >= 2 && nameKey.size() <= 40;
    }

    function isValidHangul(hangul) {
      return hangul is string && hangul.size() >= 1 && hangul.size() <= 20 && hangul.matches('.*[가-힣].*');
    }

    match /canonical/{nameKey} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /suggestions/{suggestionId} {
      allow read: if true;
      allow create: if request.auth != null
        && isValidNameKey(request.resource.data.nameKey)
        && isValidHangul(request.resource.data.hangul)
        && request.resource.data.status == "pending"
        && request.resource.data.votesUp >= 0
        && request.resource.data.votesDown >= 0
        && request.resource.data.reportCount >= 0
        && request.resource.data.score == (request.resource.data.votesUp - request.resource.data.votesDown)
        && request.resource.data.createdBy == request.auth.uid;
      allow update: if isAdmin() || (request.auth != null
        && request.resource.data.nameKey == resource.data.nameKey
        && request.resource.data.hangul == resource.data.hangul
        && request.resource.data.status == resource.data.status
        && request.resource.data.createdBy == resource.data.createdBy
        && request.resource.data.votesUp >= resource.data.votesUp
        && request.resource.data.votesDown >= resource.data.votesDown
        && request.resource.data.reportCount >= resource.data.reportCount
        && request.resource.data.votesUp - resource.data.votesDown == request.resource.data.score
        && request.resource.data.votesUp - resource.data.votesDown >= -9999
        && request.resource.data.votesUp - resource.data.votesDown <= 9999
        && (request.resource.data.votesUp == resource.data.votesUp + 1
            || request.resource.data.votesDown == resource.data.votesDown + 1
            || request.resource.data.reportCount == resource.data.reportCount + 1)
      );
      allow delete: if false;
    }

    match /votes/{voteId} {
      allow get: if request.auth != null && voteId.matches('.*_' + request.auth.uid);
      allow list: if false;
      allow create: if request.auth != null
        && isValidNameKey(request.resource.data.nameKey)
        && (request.resource.data.vote == 1 || request.resource.data.vote == -1)
        && request.resource.data.suggestionId is string;
      allow update, delete: if false;
    }

    match /reports/{reportId} {
      allow get: if request.auth != null && reportId.matches('.*_' + request.auth.uid);
      allow list: if false;
      allow create: if request.auth != null
        && isValidNameKey(request.resource.data.nameKey)
        && request.resource.data.suggestionId is string;
      allow update, delete: if false;
    }

    match /moderationLog/{logId} {
      allow read, write: if isAdmin();
    }
  }
}
